input {
  udp {
    port => 5140
    type => "pfsense"
  }
  tcp {
    port => 5140
    type => "pfsense"
  }
}

filter {
  # THÊM: Log ra message gốc để debug
  mutate {
    add_field => { "[@metadata][raw_message]" => "%{message}" }
  }

  if [type] == "pfsense" {
    # 1. Tách Header Syslog (Chuẩn RFC 5424)
    grok {
      match => { "message" => "^<%{POSINT:syslog_pri}>1 %{TIMESTAMP_ISO8601:log_timestamp} %{HOSTNAME:hostname} %{WORD:program} %{INT:pid} - - %{GREEDYDATA:filter_message}" }
      # THÊM: Nếu không match, đánh dấu
      tag_on_failure => ["_grokparsefailure_header"]
    }

    # 2. Lấy thông tin cơ bản để kiểm tra phiên bản IP
    if "_grokparsefailure_header" not in [tags] {
      csv {
        source => "filter_message"
        separator => ","
        columns => [
          "rule_number","sub_rule_number","anchor","tracker","real_interface","reason","action","dir","ip_version"
        ]
        autogenerate_column_names => false
      }

      # 3. QUAN TRỌNG: Nếu không phải IPv4 thì vứt bỏ ngay lập tức
      if [ip_version] != "4" {
        drop {}
      }

      # 4. Nếu là IPv4, phân tích chi tiết toàn bộ chuỗi
      csv {
        source => "filter_message"
        separator => ","
        columns => [
          "rule_number","sub_rule_number","anchor","tracker","real_interface","reason","action","dir","ip_version",
          "tos","ecn","ttl","id","offset","flags","proto_id","proto_name",
          "length","src_ip","dst_ip",
          "src_port","dst_port","data_length","tcp_flags","sequence_number","ack","window","urg","options"
        ]
      }

      # 5. Xử lý dữ liệu
      date {
        match => [ "log_timestamp", "ISO8601" ]
        target => "@timestamp"
      }

      mutate {
        convert => {
          "src_port" => "integer"
          "dst_port" => "integer"
          "length" => "integer"
          "id" => "integer"
          "rule_number" => "integer"
          "tracker" => "integer"
        }
      }

      mutate {
        remove_field => ["message", "filter_message", "log_timestamp", "syslog_pri", "anchor", "sub_rule_number"]
      }
    }
  }
}

output {
  # THÊM: Debug output - xem mọi message
  stdout {
    codec => rubydebug {
      metadata => true
    }
  }

  # Chỉ gửi vào ES nếu không có lỗi parse
  if "_grokparsefailure_header" not in [tags] {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "pfsense-ipv4-%{+YYYY.MM.dd}"
      manage_template => false
    }
  } else {
    # THÊM: Gửi các message lỗi vào index riêng để debug
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "pfsense-parse-errors-%{+YYYY.MM.dd}"
      manage_template => false
    }
  }
}